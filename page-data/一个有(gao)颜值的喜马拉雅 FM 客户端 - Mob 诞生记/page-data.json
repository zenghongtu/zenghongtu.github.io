{"componentChunkName":"component---src-templates-post-template-js","path":"/一个有(gao)颜值的喜马拉雅 FM 客户端 - Mob 诞生记/","webpackCompilationHash":"c350e791ebf0e69a7acf","result":{"data":{"post":{"id":"7535a9e0-93a5-5969-bba7-03b13a020054","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4cbcfe72317ed4975b7f9857316fd15e/00397/icon.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 256px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEU0lEQVQ4y12US2wTRxjHx7EqETUEEBXEj/Xuzsw+vOv4kTjQJI4dO2qcBDsplIZHk5ImwU2KWhAOoimElp5666VSK1VColwKqoDkxCG3tCqo6rU5IFVqe6iEqCo4hSSerzO7tmM60mpmd+f7zff4z4dQdVDcjogacdb6LoSwnWmS3vnGi/43gnP3mnBs0KvtaXbehY2wfWkQAcMxZ63ta/W0Xf/dU/vHtzbrXtSmv4J8NkItte+7/wUPbQs4+/jhdWdcz6ow6pOadg6JZpT+0ndyvrwujyw+k48sPpeHFh4rubk72OwZqe9TI44NiWRdaI1cg3UitEtJTd5UClcAZ0tA4nkgehcQ2gEkmgPcPwNK4SoomZkVA6H9DozEXShNoHqYdVh/aU0tfAJE69ymQbxFZbNCg4Sp3SeZmhyraAf9WxywjYfKoA58sK4j9JoTdkD11AvAc+acIDwTMCrRDapYjBtyzxJMAJWBc0ztOc34P6AkxmhA3dDy54Gkpx44tgCIhnS3mtWcpUWYjmcujFHVZtxD4Mag8PDlY18ADaqMiP+4nRHV3jRGykDt1LjDsFJeJE240lCy79/EuTnh3RbfzGfCoTFQu44CzzPwVID00aqzJp1FfhifQ8aW2f0WGNnpVcE4fBc8dWnI+YvrNJIB7WBbhReByYUlkM7eAWnme5CHL4My+hkopR+AWL1AR5eA+GWGA7ii6UmwclNPQl50oK5DXq02ubj0jOcJlDcuMOnUV8x3/Q8IXHoEgfJPIPFZmV8GvPgr0MmvwfxwGczRRWamTjA7NwWR3JkXlCZijUCfXLz2nGsO5MIVJk1+6wCDCz9DsPwjyJd/ATx/H7SPH4E+fQMi55fBOv45C/e/yyKDJYjmJjeplojXgeIGyEPlx5SHI0LGVoqFxr+E0PwKyLO3AfNi0bFrYMzeAs3ug3DxEpAgdULWtThEM+NPg637/NW7ed+VTG7+Nu4/6xRFJJxKGiNmN5Duk6LyoKXPgFW6BfxmgdFVEJUGLFvbka48xNLH1wRj4S9eFHHRHWGGe0aU4lXgld3mQFFhRpWweIAEMOh9E2Ad+9TxjChcTjgqgJvJgVMQbk/NCIYZ6fUirbUZtfzjllvJzK7g4QWhuw0uD8YFzEUcZ0TSmZmeYEZXUayFsEENai8SqTGI9RQfclO3SYTMaoOodg3+ul8dOPcbzV8AIVoiaVs8tAqfmfn6m8zoHK6ofnWbe7gpYIn00b99r+7FjqgVq6nez6otzPkg7iZOv/dAP7IABhetbqeAS4I/cTCsbogkByE5cBpivaMPfS17HJgRPuSkTdM73F4o+llj13C8tvvGjdzMajg3/cTmOmvPTmxGMyeextJvr5luzjyNMLsju9MTxYK0Z921X/X4+UWvjZAHHdCMQ1HNPBwP7t7rf6kxV8O0O3I7sIZGyftZh+sd7xrE6vMma3ezYVz8EzyimjhkoFqYjbD/AFzvnSkq5XqrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"icon\"\n        title=\"\"\n        src=\"/static/4cbcfe72317ed4975b7f9857316fd15e/00397/icon.png\"\n        srcset=\"/static/4cbcfe72317ed4975b7f9857316fd15e/9ec3c/icon.png 200w,\n/static/4cbcfe72317ed4975b7f9857316fd15e/00397/icon.png 256w\"\n        sizes=\"(max-width: 256px) 100vw, 256px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote>\n<p>GitHub: <a href=\"https://github.com/zenghongtu/Mob\">zenghongtu/Mob</a></p>\n</blockquote>\n<h2>前言</h2>\n<p>最近一个月沉迷喜马拉雅无法自拔，听相声、段子、每日新闻，还有英语听力，摸鱼学习两不误。上班时候苦于没有桌面端，用网页版有些 bug，官方也不搞一个，只好自己动手了。样式参考了一下 Moon FM /t/555343，颜值还过得去，自我感觉挺好 😜😜😜</p>\n<h2>功能及 UI</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f86d825c0e70dc0325161a248dae4bc/df67e/2019-05-13-00-26-40.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 70.68376068376068%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAADjklEQVQ4y02T20/bdRjG+2/4L/gHeKG3huCFxsS5GC9cZoaJWTTLXGbClih4IDM6HAyNCUYYkEFbyloOjgEFyrEtbSk90AMt/R16PvxaeqIw8vHbsQsvnrzP9/A+eY+6i5cvqZVzVIolqjmNcrpAtVihXNKo1+ucn59zdnZGq3n6Gk1OG200OK2/huDtPxcXF+hqwkk+COGcW2XvXxuHy05i7iApSeWsWqdZqXEqbKNUoXUiHKtNmlqVhtagJd7ad636GfVaHU3T0FWrVSq5IpnIMelonKKUpJRK8bCvB9OzRbKygm/XRSFboL/vZ3q777G3vcWLP3sw6heY+OsxxoFvSMohSlrlUjCQUHFGJbzHKgdSinBC4tonH3H3fg/xiITNuEDQH+SLa5/yQce76E0zfH2lk8Ffh/iq6zpvv/kGG5vrNEQpXgmueYNM2RzMOfaZtXvwxhLYXW4Oo1FS+TKRsEquVMYXiuA6CJAqFNi2u0nIKp7DEOtON8lsllKxeCmYE0TKZFHzeaRsDjmT4ePOd3j/vQ4CoRhDg5+RUgNI8TiLz0y0TjUe9HazaJnhjmmajls3WXV5aNaq6MqVCpuxMCsC23KcLSlGNJ9lsL+P3u/u4Q4e8cfIMAlVEaIq0lEE7aTIzoYFp9PO6Noi90emiIral7WSiPDkhK1EFEvUz6IU4bnAQVrFMDmGxWwgeuzH518T6YVwOJdxu5YJhgMMD4/j2feR9FhxLBkpFlKiKeW2YBVvNInNJ2E/TOIMZ/BHZK53vsXdz69inh7jzs0Pmbc8xTTej9U8xsLcPF1XbjDw/UMOrU8w9FylpESoNU7RnYgIX8z6MYy6WTAEsUwE8O8lsT63srd7IODjyYSe/f0wYV+UkLBSPI3xHz0uh5+sEicRdKAVxUJUa+jq9RpHcgab9whPXIyN4LFkhke/D9Db+yNavsD+zAK0zlHmt1AMK+yubXOr6zb6ET0lxybhp2YKqRL1Ru0yZaPHQ8/qEj+trfCDdRGT18PQ8N8Mjo7g8nuZvNGNe30Xv92LcqQwu77J7S+/5ZcHj/D8ZsL+eIoj0ZSKyFbXLqTZuolBpDiztM7Q+ATjVitTGxtM7+4wadtAL6zBvsv0nhOj04HRYcewvY3FtoNZRGvesjO3sUO+IOawvdTpdBpFUVDFaCTVJGqbCyiyfMnlNmQU6X9onxX5lZ8sSaTFura1/gOzyLH+s9EpfAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"2019 05 13 00 26 40\"\n        title=\"\"\n        src=\"/static/7f86d825c0e70dc0325161a248dae4bc/8ff1e/2019-05-13-00-26-40.png\"\n        srcset=\"/static/7f86d825c0e70dc0325161a248dae4bc/9ec3c/2019-05-13-00-26-40.png 200w,\n/static/7f86d825c0e70dc0325161a248dae4bc/c7805/2019-05-13-00-26-40.png 400w,\n/static/7f86d825c0e70dc0325161a248dae4bc/8ff1e/2019-05-13-00-26-40.png 800w,\n/static/7f86d825c0e70dc0325161a248dae4bc/df67e/2019-05-13-00-26-40.png 1170w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>目前实现的功能有这些：</p>\n<ul>\n<li>一个基本的音乐播放器</li>\n<li>每日必听</li>\n<li>推荐</li>\n<li>排行榜</li>\n<li>分类</li>\n<li>订阅</li>\n<li>听过</li>\n<li>下载声音</li>\n<li>搜索专辑</li>\n</ul>\n<h2>技术选型</h2>\n<p>技术栈：</p>\n<ul>\n<li><a href=\"https://github.com/electron/electron\">Electron</a></li>\n<li><a href=\"https://github.com/umijs/umi\">Umi</a></li>\n<li><a href=\"https://github.com/dvajs/dva\">Dva</a></li>\n<li><a href=\"https://github.com/ant-design/ant-design\">Antd</a></li>\n</ul>\n<p>之所以选择 Umi 是因为在之前项目中研究过其部分源码，开发体验感不错，而且 bug 也少。\n还有一个原因是我在找模板的过程中，看到这个大佬的模板<a href=\"https://github.com/wangtianlun/umi-electron-typescript\">wangtianlun/umi-electron-typescript</a>，就直接拿来用了，大大减少了我搭建开发环境的时间，在此表示感谢~</p>\n<blockquote>\n<p>如果你对 Umi 和 Dva 不熟，墙裂建议去学一下，分分钟就可以上手，而且开发效率要提高的不要太多。</p>\n</blockquote>\n<h2>开发篇</h2>\n<h3>React Hooks 使用问题</h3>\n<p>在开发中，所有组件、页面都是使用 React Hooks 进行开发的。而让我觉得最难以琢磨的一个 hooks 非 <code class=\"language-text\">useEffect</code> 莫属。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ...</span>\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    ipcRenderer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HOTKEY\"</span><span class=\"token punctuation\">,</span> handleGlobalShortcut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ipcRenderer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DOWNLOAD\"</span><span class=\"token punctuation\">,</span> handleDownloadStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      ipcRenderer<span class=\"token punctuation\">.</span><span class=\"token function\">removeListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HOTKEY\"</span><span class=\"token punctuation\">,</span> handleGlobalShortcut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      ipcRenderer<span class=\"token punctuation\">.</span><span class=\"token function\">removeListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DOWNLOAD\"</span><span class=\"token punctuation\">,</span> handleDownloadStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>volume<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleGlobalShortcut</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span> hotkey</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>hotkey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"nextTrack\"</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">handleNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"prevTrack\"</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">handlePrev</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"volumeUp\"</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">const</span> volumeUp <span class=\"token operator\">=</span> volume <span class=\"token operator\">></span> <span class=\"token number\">0.95</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> volume <span class=\"token operator\">+</span> <span class=\"token number\">0.05</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">handleVolume</span><span class=\"token punctuation\">(</span>volumeUp <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"volumeDown\"</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">const</span> volumeDown <span class=\"token operator\">=</span> volume <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.05</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">:</span> volume <span class=\"token operator\">-</span> <span class=\"token number\">0.05</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">handleVolume</span><span class=\"token punctuation\">(</span>volumeDown <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"changePlayState\"</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">handlePlayPause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p>为了减少渲染次数，我会设置了第二参数为 <code class=\"language-text\">[volume]</code>，但这会导致一些出乎意料的情况，比如我触发了<code class=\"language-text\">changePlayState</code>，但却并没有得到意料中的值，这个时候设置为 <code class=\"language-text\">[volume, playState]</code> 就正常了。</p>\n<p>原因很简单，因为<code class=\"language-text\">playState</code>不在依赖中，不会触发重新渲染</p>\n<p>所以这条经验就是在使用 hook 遇到问题时，可以先试一下添加到`useEffect·中（如果有用到这个 hook 的话）</p>\n<h3>组件复用</h3>\n<p>先来看一下预览：</p>\n<p><img src=\"/mob-preview-554e7b29ac6d21997f66a484e7eb752a.gif\"></p>\n<p>可以发现很多组件是相似的，如何提高他们的复用，这一个提高开发效率的途径。</p>\n<p>在这个项目中我没有使用高阶组件，而是通过反正控制或者说是<code class=\"language-text\">render props</code>来进行复用，在组件的指定生命周期中进行调用。</p>\n<p>共有三个组件在其他多个组件和页面中复用：</p>\n<ul>\n<li>页面内容加载组件</li>\n<li>专辑封面组件</li>\n<li>专辑列表组件</li>\n</ul>\n<p>页面内容加载组件如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Content</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">render</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result<span class=\"token punctuation\">:</span> Result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">genRequestList</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">params<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">R</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Array<span class=\"token operator\">&lt;</span>Promise<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">rspHandler</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">rspArr<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span> lastResult<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Result<span class=\"token punctuation\">;</span>\n  params<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">R</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  params<span class=\"token punctuation\">,</span> <span class=\"token comment\">// api 的请求参数</span>\n  genRequestList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 负责返回 api 请求列表，返回值会被`Content`调用请求数据，返回值给`rspHandler`</span>\n  rspHandler<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 处理请求返回的`Response`值，返回值给`render`</span>\n  render <span class=\"token comment\">//  负责渲染结果，将值传递给`render`函数中的组件</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> Content<span class=\"token operator\">&lt;</span>any<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>loading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>hasError<span class=\"token punctuation\">,</span> setError<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>result<span class=\"token punctuation\">,</span> setResult<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">setError</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> rspArr <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token function\">genRequestList</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">setResult</span><span class=\"token punctuation\">(</span><span class=\"token function\">rspHandler</span><span class=\"token punctuation\">(</span>rspArr<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">setError</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">.</span>contentWrap<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>loading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>result <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">.</span>loading<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>Loading <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> hasError <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>Empty image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>Empty<span class=\"token punctuation\">.</span><span class=\"token constant\">PRESENTED_IMAGE_SIMPLE</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>利用缓存提高体验度</h3>\n<p>对 axios 的 get 请求进行封装，对每个请求 url 生成唯一值，如果在白名单内，存入 session storage 中，默认过期时间是 3600s，在下次访问时，直接返回该值。</p>\n<p>这样做的一个问题是无法获得最新数据，但对比体验感来说并不那么严重。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">request</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> whitelist <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> expiry <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_EXPIRY</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>instance<span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">get</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> config<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> AxiosRequestConfig</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      config<span class=\"token punctuation\">.</span>url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> fingerprint <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">||</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 判断是否需要缓存</span>\n    <span class=\"token keyword\">const</span> isNeedCache <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>whitelist<span class=\"token punctuation\">.</span>length <span class=\"token operator\">||</span> whitelist<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 生成唯一值</span>\n    <span class=\"token keyword\">const</span> hashKey <span class=\"token operator\">=</span> hash\n      <span class=\"token punctuation\">.</span><span class=\"token function\">sha256</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>fingerprint<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hex\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expiry <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> cached <span class=\"token operator\">=</span> sessionStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span>hashKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> lastCachedTS<span class=\"token punctuation\">:</span> number <span class=\"token operator\">=</span> <span class=\"token operator\">+</span>sessionStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>hashKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:TS`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cached <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> lastCachedTS <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> age <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastCachedTS<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 如果没有过期，就直接返回该值</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>age <span class=\"token operator\">&lt;</span> expiry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>cached<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 否则清除之前的旧值</span>\n        sessionStorage<span class=\"token punctuation\">.</span><span class=\"token function\">removeItem</span><span class=\"token punctuation\">(</span>hashKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        sessionStorage<span class=\"token punctuation\">.</span><span class=\"token function\">removeItem</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>hashKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:TS`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> rsp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isNeedCache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">cacheRsp</span><span class=\"token punctuation\">(</span>rsp<span class=\"token punctuation\">,</span> hashKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> rsp<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> whitelist<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Flex <code class=\"language-text\">justify-content: space-between</code> 最后一行问题</h3>\n<p>在 flex 中设置<code class=\"language-text\">justify-content: space-between</code>后，在最后一行会出现让人不愉悦的情况。</p>\n<p>对于这个问题，我的办法是通过计算然后填充空的<code class=\"language-text\">div</code>进去。</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_WIDTH</span> <span class=\"token operator\">=</span> <span class=\"token number\">130</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_PAGE_COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">130</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_WINDOW_WIDTH</span> <span class=\"token operator\">=</span> <span class=\"token number\">1040</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span>\n  siderWidth <span class=\"token operator\">=</span> <span class=\"token constant\">SIDE_BAR_WIDTH</span><span class=\"token punctuation\">,</span>\n  pageCount <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_PAGE_COUNT</span><span class=\"token punctuation\">,</span>\n  divWidth <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_WIDTH</span>\n<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>fillCount<span class=\"token punctuation\">,</span> setFillCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> handleResize <span class=\"token operator\">=</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> innerWidth<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      innerWidth <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 当前容器的宽度</span>\n    <span class=\"token keyword\">const</span> containerWidth <span class=\"token operator\">=</span> innerWidth <span class=\"token operator\">||</span> <span class=\"token constant\">DEFAULT_WINDOW_WIDTH</span> <span class=\"token operator\">-</span> siderWidth<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 每一行可以放的个数</span>\n    <span class=\"token keyword\">const</span> rowDivCount <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>containerWidth <span class=\"token operator\">/</span> divWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 需要填充的个数</span>\n    <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> rowDivCount <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>pageCount <span class=\"token operator\">%</span> rowDivCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setFillCount</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">handleResize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"resize\"</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"resize\"</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>fillCount\n        <span class=\"token operator\">?</span> <span class=\"token comment\">// 按照填充个数填进去</span>\n          <span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> length<span class=\"token punctuation\">:</span> fillCount <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n              <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>idx<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">:</span> divWidth<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">className</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">.</span>filler<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>路由的前进与后退</h3>\n<p>在<code class=\"language-text\">umi</code>或者说是<code class=\"language-text\">react-router</code>中，也只有<code class=\"language-text\">memory-router</code>可以判断是否可以前进或者后退。</p>\n<p>只能自己记录一下 index，然后进行判断。</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">let</span> lastHistoryLen <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">NavBar</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> history<span class=\"token punctuation\">,</span> isLogin <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> length<span class=\"token punctuation\">,</span> action <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> history<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>curIndx<span class=\"token punctuation\">,</span> setCurIndx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>suggests<span class=\"token punctuation\">,</span> setSuggests<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>text<span class=\"token punctuation\">,</span> setText<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>visible<span class=\"token punctuation\">,</span> setVisible<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">// 判断最后历史记录的长度是否大于当前历史记录长度，如果是的话，把 index 归零</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastHistoryLen <span class=\"token operator\">></span> length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setCurIndx</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    lastHistoryLen <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> fetchSuggests <span class=\"token operator\">=</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">kw</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>kw<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setSuggests</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> result <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">:</span> SuggestRspData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSuggest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> kw <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> suggests <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>result<span class=\"token punctuation\">.</span>albumResultList<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>result<span class=\"token punctuation\">.</span>queryResultList<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>suggests<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      suggests <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// todo (only support albumResult now)</span>\n    <span class=\"token function\">setSuggests</span><span class=\"token punctuation\">(</span>suggests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleArrowClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">n</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setCurIndx</span><span class=\"token punctuation\">(</span>curIndx <span class=\"token operator\">+</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      router<span class=\"token punctuation\">.</span><span class=\"token function\">go</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>如何登录</h3>\n<p>本来想着分析一下登录接口，但是这么做的话，如果还要加上扫码登录，要花不少时间。</p>\n<p>于是乎想到了使用 <code class=\"language-text\">webview</code> 嵌入登录页面，在登录后，如果打开了个人页面就说明登录成功了。</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">TARGET_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"www.ximalaya.com/passport/sync_set\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COOKIE_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://www.ximalaya.com\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">WebView</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> onLoadedSession <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isLoading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> webview <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#xmlyWebView\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleDOMReady</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>webview<span class=\"token punctuation\">.</span><span class=\"token function\">getURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TARGET_URL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// todo fix prevent redirect</span>\n        e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> webview<span class=\"token punctuation\">.</span><span class=\"token function\">getWebContents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">onLoadedSession</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">,</span> <span class=\"token constant\">COOKIE_URL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        webview<span class=\"token punctuation\">.</span><span class=\"token function\">reload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleLoadCommit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleDidFinishLoad</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    webview<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dom-ready\"</span><span class=\"token punctuation\">,</span> handleDOMReady<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    webview<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load-commit\"</span><span class=\"token punctuation\">,</span> handleLoadCommit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    webview<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"did-finish-load\"</span><span class=\"token punctuation\">,</span> handleDidFinishLoad<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      webview<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dom-ready\"</span><span class=\"token punctuation\">,</span> handleDOMReady<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      webview<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load-commit\"</span><span class=\"token punctuation\">,</span> handleLoadCommit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      webview<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"did-finish-load\"</span><span class=\"token punctuation\">,</span> handleDidFinishLoad<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"xmlyWebView\"</span><span class=\"token punctuation\">,</span>\n    useragent<span class=\"token punctuation\">:</span>\n      <span class=\"token comment\">// tslint:disable-next-line:max-line-length</span>\n      <span class=\"token string\">\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36\"</span><span class=\"token punctuation\">,</span>\n    src<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`https://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">TARGET_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">,</span>\n    style<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> widht<span class=\"token punctuation\">:</span> <span class=\"token string\">\"750px\"</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">:</span> <span class=\"token string\">\"600px\"</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Spin</span></span> <span class=\"token attr-name\">tip</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Loading...<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">spinning</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>isLoading<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>webview</span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">props</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Spin</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>最后</h2>\n<p>希望这篇文章能对你有所帮助。</p>\n<p><a href=\"https://github.com/zenghongtu/Mob/releases/latest\">下载与体验</a></p>","fields":{"slug":"/一个有(gao)颜值的喜马拉雅 FM 客户端 - Mob 诞生记/","prefix":"2019-05-13"},"frontmatter":{"title":"一个有(gao)颜值的喜马拉雅 FM 客户端 - Mob 诞生记","author":"Jason Zeng","category":"electron","cover":{"childImageSharp":{"resize":{"src":"/static/1987c5c58c2244954d181b9a6c2037c9/fdbb0/watercolour-4117017.png"}}}}},"authornote":{"id":"eeaf3f36-861e-5339-a4a4-e63a63ccd23c","html":"<p><a href=\"https://github.com/zenghongtu\">Jason Zeng</a></p>"},"site":{"siteMetadata":{"facebook":{"appId":"2349655921921608"}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/一个有(gao)颜值的喜马拉雅 FM 客户端 - Mob 诞生记/","prev":{"id":"ccb1c8e5-d57d-5b38-a349-adb783458ffa","fields":{"slug":"/一个纯 CSS 实现的'简约'搜索框/","prefix":"2019-04-05","source":"posts"},"frontmatter":{"title":"一个纯 CSS 实现的'简约'搜索框","category":"CSS"}},"source":"posts"}}}